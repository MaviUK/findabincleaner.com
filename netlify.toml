########################
# Build & Functions
########################
[build]
  command   = "npm run build"
  publish   = "dist"
  functions = "netlify/functions"

[functions]
  node_bundler = "esbuild"
  external_node_modules = ["stripe", "@supabase/supabase-js"]
  included_files = ["netlify/functions/**"]
  # body = "raw"  # (optional) global

# Ensure ONLY the Stripe webhook gets a raw body
[functions."stripe-webhook"]
  body = "raw"

# Optional (for local dev with `ntl dev`)
[dev]
  framework = "vite"

########################
# API / Functions redirects (FIRST)
########################
# Area sponsorship APIs
[[redirects]]
  from = "/api/area/availability"
  to   = "/.netlify/functions/area-availability"
  status = 200

[[redirects]]
  from = "/api/area/preview"
  to   = "/.netlify/functions/area-preview"
  status = 200

# Geo JSON feeds
[[redirects]]
  from = "/api/geo/my-coverage"
  to   = "/.netlify/functions/geo-my-coverage"
  status = 200

[[redirects]]
  from = "/api/geo/my-wins"
  to   = "/.netlify/functions/geo-my-wins"
  status = 200

[[redirects]]
  from = "/api/geo/available"
  to   = "/.netlify/functions/geo-available"
  status = 200

# Sponsorship (legacy)
[[redirects]]
  from = "/api/sponsored/purchase"
  to   = "/.netlify/functions/sponsored-purchase"
  status = 200

[[redirects]]
  from = "/api/sponsored/preview"
  to   = "/.netlify/functions/sponsored-preview"
  status = 200

[[redirects]]
  from = "/api/sponsored/checkout"
  to   = "/.netlify/functions/sponsored-checkout"
  status = 200

# Stripe webhook (server-to-server)
[[redirects]]
  from = "/api/stripe/webhook"
  to   = "/.netlify/functions/stripe-webhook"
  status = 200

# Post-verify alias
[[redirects]]
  from = "/api/stripe/postverify"
  to   = "/.netlify/functions/stripe-postverify"
  status = 200

# Billing Portal
[[redirects]]
  from = "/api/billing/portal"
  to   = "/.netlify/functions/billing-portal"
  status = 200

########################
# API headers (disable CDN caching for JSON)
########################
[[headers]]
  for = "/api/*"
  [headers.values]
    Cache-Control = "no-store, no-cache, must-revalidate, max-age=0"
    Pragma        = "no-cache"
    Expires       = "0"

[[headers]]
  for = "/.netlify/functions/*"
  [headers.values]
    Cache-Control = "no-store, no-cache, must-revalidate, max-age=0"
    Pragma        = "no-cache"
    Expires       = "0"

########################
# SPA catch-all (LAST)
########################
[[redirects]]
  from = "/*"
  to   = "/index.html"
  status = 200
