########################
# Build & Functions
########################
[build]
  command   = "npm run build"
  publish   = "dist"
  functions = "netlify/functions"

[functions]
  node_bundler = "esbuild"
  external_node_modules = ["stripe", "@supabase/supabase-js"]
  included_files = ["netlify/functions/**"]

# Only the Stripe webhook needs raw body for signature verification
[functions."stripe-webhook"]
  body = "raw"

[dev]
  framework = "vite"

########################
# API / Functions redirects (FIRST)
########################

# Areas & Geo endpoints
[[redirects]]
  from = "/api/area/availability"
  to   = "/.netlify/functions/area-availability"
  status = 200

[[redirects]]
  from = "/api/area/preview"
  to   = "/.netlify/functions/area-preview"
  status = 200

[[redirects]]
  from = "/api/geo/my-coverage"
  to   = "/.netlify/functions/geo-my-coverage"
  status = 200

[[redirects]]
  from = "/api/geo/my-wins"
  to   = "/.netlify/functions/geo-my-wins"
  status = 200

[[redirects]]
  from = "/api/geo/available"
  to   = "/.netlify/functions/geo-available"
  status = 200

# Sponsorship checkout/preview (legacy)
[[redirects]]
  from = "/api/sponsored/purchase"
  to   = "/.netlify/functions/sponsored-purchase"
  status = 200

[[redirects]]
  from = "/api/sponsored/preview"
  to   = "/.netlify/functions/sponsored-preview"
  status = 200

[[redirects]]
  from = "/api/sponsored/checkout"
  to   = "/.netlify/functions/sponsored-checkout"
  status = 200

# Stripe webhook endpoint (this is the URL configured in Stripe)
[[redirects]]
  from = "/api/stripe/webhook"
  to   = "/.netlify/functions/stripe-webhook"
  status = 200

# Post-verify alias (nice UX for Dashboard)
[[redirects]]
  from = "/api/stripe/postverify"
  to   = "/.netlify/functions/stripe-postverify"
  status = 200

# Billing Portal
[[redirects]]
  from = "/api/billing/portal"
  to   = "/.netlify/functions/billing-portal"
  status = 200

# Manage view: subscription info + cancel-at-period-end
[[redirects]]
  from = "/api/subscription/get"
  to   = "/.netlify/functions/subscription-get"
  status = 200

[[redirects]]
  from = "/api/subscription/cancel"
  to   = "/.netlify/functions/subscription-cancel"
  status = 200

########################
# API headers (disable CDN caching for JSON)
########################
[[headers]]
  for = "/api/*"
  [headers.values]
    Cache-Control = "no-store, no-cache, must-revalidate, max-age=0"
    Pragma        = "no-cache"
    Expires       = "0"

# If you call functions directly without /api redirects
[[headers]]
  for = "/.netlify/functions/*"
  [headers.values]
    Cache-Control = "no-store, no-cache, must-revalidate, max-age=0"
    Pragma        = "no-cache"
    Expires       = "0"

########################
# SPA catch-all (LAST)
########################
[[redirects]]
  from = "/*"
  to   = "/index.html"
  status = 200

# ...
[[redirects]]
  from = "/api/area/sponsorship"
  to = "/.netlify/functions/area-sponsorship"
  status = 200
