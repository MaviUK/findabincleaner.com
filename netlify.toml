########################
# Build & Functions
########################
[build]
  command   = "npm run build"
  publish   = "dist"
  functions = "netlify/functions"

# Single global functions table (NO DUPLICATES)
[functions]
  node_bundler = "esbuild"
  external_node_modules = ["stripe", "@supabase/supabase-js", "@turf/turf"]
  included_files = ["netlify/functions/**"]

# Stripe webhook needs raw body for signature verification
[functions."stripe-webhook"]
  body = "raw"

[dev]
  framework = "vite"

########################
# Scheduled Functions
########################
[[scheduled.functions]]
  name = "sendRenewalNotices"
  cron = "0 * * * *" # every hour

########################
# API / Functions redirects (FIRST)
########################

# Areas & Geo endpoints
[[redirects]]
  from = "/api/area/availability"
  to   = "/.netlify/functions/area-availability"
  status = 200

[[redirects]]
  from = "/api/area/preview"
  to   = "/.netlify/functions/area-preview"
  status = 200

[[redirects]]
  from = "/api/geo/my-coverage"
  to   = "/.netlify/functions/geo-my-coverage"
  status = 200

[[redirects]]
  from = "/api/geo/my-wins"
  to   = "/.netlify/functions/geo-my-wins"
  status = 200

[[redirects]]
  from = "/api/geo/available"
  to   = "/.netlify/functions/geo-available"
  status = 200

# Sponsorship: availability / painting helper
[[redirects]]
  from = "/api/area/sponsorship"
  to   = "/.netlify/functions/area-sponsorship"
  status = 200

# Sponsorship checkout / preview
[[redirects]]
  from = "/api/sponsored/purchase"
  to   = "/.netlify/functions/sponsored-purchase"
  status = 200

[[redirects]]
  from = "/api/sponsored/preview"
  to   = "/.netlify/functions/sponsored-preview"
  status = 200

[[redirects]]
  from = "/api/sponsored/checkout"
  to   = "/.netlify/functions/sponsored-checkout"
  status = 200

# Stripe webhook endpoint (configured in Stripe)
[[redirects]]
  from = "/api/stripe/webhook"
  to   = "/.netlify/functions/stripe-webhook"
  status = 200

# Post-verify alias (dashboard UX)
[[redirects]]
  from = "/api/stripe/postverify"
  to   = "/.netlify/functions/stripe-postverify"
  status = 200

# Billing Portal
[[redirects]]
  from = "/api/billing/portal"
  to   = "/.netlify/functions/billing-portal"
  status = 200

# Subscription management
[[redirects]]
  from = "/api/subscription/get"
  to   = "/.netlify/functions/subscription-get"
  status = 200

[[redirects]]
  from = "/api/subscription/cancel"
  to   = "/.netlify/functions/subscription-cancel"
  status = 200

# Analytics
[[redirects]]
  from = "/api/record_event"
  to   = "/.netlify/functions/record_event"
  status = 200

########################
# API headers (disable caching)
########################
[[headers]]
  for = "/api/*"
  [headers.values]
    Cache-Control = "no-store, no-cache, must-revalidate, max-age=0"
    Pragma        = "no-cache"
    Expires       = "0"

# Direct function calls
[[headers]]
  for = "/.netlify/functions/*"
  [headers.values]
    Cache-Control = "no-store, no-cache, must-revalidate, max-age=0"
    Pragma        = "no-cache"
    Expires       = "0"

########################
# SPA catch-all (LAST)
########################
[[redirects]]
  from = "/*"
  to   = "/index.html"
  status = 200

[functions."billing-reminders"]
  schedule = "@hourly"


  external_node_modules = ["stripe", "@supabase/supabase-js", "@turf/turf", "resend", "pdf-lib"]

